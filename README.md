# Adventure Log Backend

## Table of Contents

- [Overview](#overview)
- [Features](#features)
- [Setup](#setup)
- [Environment Variables](#environment-variables)
- [API Endpoints](#api-endpoints)
- [Database Schema](#database-schema)
- [Code Structure](#code-structure)
- [Testing](#testing)
- [Deployment](#deployment)
- [Contributing](#contributing)
- [License](#license)

---

## Overview

Adventure Log is a RESTful API designed to help users manage their trips, stops, and associated media. It provides robust authentication, rate-limiting, and media upload capabilities.

---

## Features

- User authentication (signup, login, logout, password reset, email verification)
- Trip management (create, update, delete, mark as complete)
- Stop management (create, update, delete stops for trips)
- Media management (upload and delete photos/videos for trips or stops)
- Rate limiting for API endpoints
- Secure JWT-based authentication
- PostgreSQL database with migrations
- Dockerized deployment

---

## Setup

### Prerequisites

- Go 1.24.1 or later
- PostgreSQL
- Docker (optional for containerized deployment)

### Steps

1. Clone the repository:

   ```bash
   git clone https://github.com/mambo-dev/adventure-log.git
   cd adventure-log
   ```

2. Install dependencies:

   ```bash
   go mod tidy
   ```

3. Set up the database:

   - Create a PostgreSQL database.
   - Apply migrations using the goose tool:
     ```bash
     goose -dir sql/schema postgres "<DATABASE_URL>" up
     ```

4. Run the application:
   ```bash
   go run main.go
   ```

---

## Environment Variables

| Variable          | Description                          | Example Value                |
| ----------------- | ------------------------------------ | ---------------------------- |
| PORT              | Port for the server                  | 8080                         |
| DATABASE_URL      | PostgreSQL connection string         | postgres://user:pass@host/db |
| JWT_SECRET        | Secret key for JWT authentication    | your-secret-key              |
| SENDGRID_API_KEY  | API key for sending emails           | your-sendgrid-key            |
| BASE_FRONTEND_URL | Frontend URL for email links         | https://frontend.com         |
| ASSETS_ROOT       | Directory for storing uploaded media | ./assets                     |
| BASE_API_URL      | Base URL for the API                 | http://localhost:8080        |

---

## API Endpoints

### Authentication

- `POST /v1/auth/signup` - Signup
- `POST /v1/auth/login` - Login
- `POST /v1/auth/refresh` - Refresh Token
- `GET /v1/auth/send-verification` - Send Verification Email
- `PUT /v1/auth/verify-email` - Verify Email
- `GET /v1/auth/request-password-reset` - Request Password Reset
- `PUT /v1/auth/reset-password` - Reset Password
- `POST /v1/auth/logout` - Logout

### Trips

- `GET /v1/trips` - Get All Trips
- `GET /v1/trips/{tripID}` - Get Trip by ID
- `POST /v1/trips` - Create Trip
- `PUT /v1/trips/{tripID}` - Update Trip
- `PATCH /v1/trips/{tripID}/end` - Mark Trip Complete
- `DELETE /v1/trips/{tripID}` - Delete Trip

### Stops

- `GET /v1/stops` - Get All Stops
- `GET /v1/stops/{stopID}` - Get Stop by ID
- `POST /v1/stops/{tripID}` - Create Stop
- `PUT /v1/stops/{stopID}` - Update Stop
- `DELETE /v1/stops/{stopID}` - Delete Stop

### Media

- `POST /v1/media/photos` - Upload Photo
- `DELETE /v1/media/{mediaID}` - Delete Photo
- `GET /v1/media/{mediaID}` - Get Photo by ID
- `GET /v1/media` - Get Media by Trip/Stop

### Admin

- `DELETE /v1/admin/reset` - Reset Database (Development only)

---

## Database Schema

### Tables

- **Users**: Stores user information.
- **Trips**: Stores trip details.
- **Trip Stops**: Stores stops associated with trips.
- **Trip Media**: Stores media (photos/videos) linked to trips or stops.
- **Refresh Tokens**: Stores refresh tokens for authentication.

> Refer to the `sql/schema` directory for detailed SQL migrations.

---

## Code Structure

### Key Directories

- `/internal/database`: Contains SQL queries and models generated by `sqlc`.
- `/internal/utils`: Utility functions for handling media, random generation, etc.
- `/internal/mailer`: Email templates and SendGrid integration.
- `/sql/schema`: Database migration files.
- `/sql/queries`: SQL queries for interacting with the database.

### Key Files

- `main.go`: Entry point for the application.
- `auth_handlers.go`: Handlers for authentication-related endpoints.
- `trips_handlers.go`: Handlers for trip-related endpoints.
- `stop_handler.go`: Handlers for stop-related endpoints.
- `media_handler.go`: Handlers for media-related endpoints.
- `rate_limiter.go`: Implements rate-limiting for API endpoints.

---

## Testing

- Run Tests:

  ```bash
  go test ./...
  ```

- Code Coverage:
  ```bash
  go test -cover ./...
  ```

---

## Deployment

### Docker

- Build the Docker image:

  ```bash
  docker build -t adventure-log .
  ```

- Run the container:
  ```bash
  docker run -p 8080:8080 --env-file .env adventure-log
  ```

### CI/CD

The project includes a GitHub Actions workflow (`.github/workflows/ci.yml`) for:

- Running tests
- Static code analysis
- Formatting checks

---

## Contributing

1. Fork the repository
2. Create a feature branch
3. Commit your changes
4. Submit a pull request.
